// ×”×’×“×¨×•×ª ×¢× ×”-Supabase ×”× ×›×•×Ÿ ×©×œ×š
const SUPABASE_URL = 'https://iasbfrurebekgtrhiimh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlhc2JmcnVyZWJla2d0cmhpaW1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MjI3ODUsImV4cCI6MjA2Mzk5ODc4NX0.hmyQmZOgMI4gTpeijYBP7f45CSdZMib1hX0jdYUuEbY';
const API_KEY = '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';

let chatCount = 0;
let totalCost = 0;

// ××œ×× ×˜×™×
const messagesDiv = document.getElementById('messages');
const inputEl = document.getElementById('input');
const statusEl = document.getElementById('status');
const usageEl = document.getElementById('usage');

// ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×”×•×“×¢×”
function addMessage(sender, text) {
    const div = document.createElement('div');
    div.className = 'message';
    const msgClass = sender === 'user' ? 'user-msg' : 'bot-msg';
    const time = new Date().toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
    
    div.innerHTML = `
        <div class="${msgClass}">
            ${text.replace(/\n/g, '<br>')}
            <div class="time">${time}</div>
        </div>
    `;
    
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××¤×§×˜ ×”×§×œ×“×”
function showTyping() {
    const div = document.createElement('div');
    div.className = 'typing';
    div.id = 'typing';
    div.innerHTML = '<div class="typing-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>';
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// ×¤×•× ×§×¦×™×” ×œ×”×¡×ª×¨×ª ××¤×§×˜ ×”×§×œ×“×”
function hideTyping() {
    const typing = document.getElementById('typing');
    if (typing) typing.remove();
}

// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××¨×—×§ ×¢×¨×™×›×” (×œ×–×™×”×•×™ ×©×’×™××•×ª ×”×§×œ×“×”)
function levenshteinDistance(str1, str2) {
    const matrix = [];
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    return matrix[str2.length][str1.length];
}

// ×¤×•× ×§×¦×™×” ×œ×–×™×”×•×™ ×¢×™×¨ ×—×›× ×¢× ×©×’×™××•×ª ×”×§×œ×“×”
function detectCity(query) {
    const cityMappings = {
        '×ª×œ ××‘×™×‘': '×ª×œ ××‘×™×‘', '×ª×œ××‘×™×‘': '×ª×œ ××‘×™×‘', '×ª"×': '×ª×œ ××‘×™×‘', '×ª×': '×ª×œ ××‘×™×‘',
        '×‘×ª×œ ××‘×™×‘': '×ª×œ ××‘×™×‘', '×‘×ª×œ××‘×™×‘': '×ª×œ ××‘×™×‘', 'tel aviv': '×ª×œ ××‘×™×‘', 'telaviv': '×ª×œ ××‘×™×‘',
        '×™×¨×•×©×œ×™×': '×™×¨×•×©×œ×™×', '×‘×™×¨×•×©×œ×™×': '×™×¨×•×©×œ×™×', '×™×¨×•×©×œ': '×™×¨×•×©×œ×™×', '×™×¨×•×©': '×™×¨×•×©×œ×™×',
        'jerusalem': '×™×¨×•×©×œ×™×', '×—×™×¤×”': '×—×™×¤×”', '×‘×—×™×¤×”': '×—×™×¤×”', 'haifa': '×—×™×¤×”',
        '×¨××ª ×’×Ÿ': '×¨××ª ×’×Ÿ', '×¨××ª×’×Ÿ': '×¨××ª ×’×Ÿ', '×‘×¨××ª ×’×Ÿ': '×¨××ª ×’×Ÿ', '×¨××ª-×’×Ÿ': '×¨××ª ×’×Ÿ',
        '×¤×ª×— ×ª×§×•×•×”': '×¤×ª×— ×ª×§×•×•×”', '×¤×ª×—×ª×§×•×•×”': '×¤×ª×— ×ª×§×•×•×”', '×‘×¤×ª×— ×ª×§×•×•×”': '×¤×ª×— ×ª×§×•×•×”', '×¤×ª"×ª': '×¤×ª×— ×ª×§×•×•×”',
        '×”×¨×¦×œ×™×”': '×”×¨×¦×œ×™×”', '×‘×”×¨×¦×œ×™×”': '×”×¨×¦×œ×™×”', '× ×ª× ×™×”': '× ×ª× ×™×”', '×‘× ×ª× ×™×”': '× ×ª× ×™×”',
        '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ': '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ', '×¨××©×•×Ÿ×œ×¦×™×•×Ÿ': '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ', '×‘×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ': '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ',
        '×‘××¨ ×©×‘×¢': '×‘××¨ ×©×‘×¢', '×‘×‘××¨ ×©×‘×¢': '×‘××¨ ×©×‘×¢', '×‘"×©': '×‘××¨ ×©×‘×¢',
        '×›×¤×¨ ×¡×‘×': '×›×¤×¨ ×¡×‘×', '×›×¤×¨×¡×‘×': '×›×¤×¨ ×¡×‘×', '×‘×›×¤×¨ ×¡×‘×': '×›×¤×¨ ×¡×‘×'
    };

    const queryLower = query.toLowerCase();
    
    // ×©×œ×‘ 1: ×”×ª×××” ××“×•×™×§×ª
    for (const [searchTerm, cityName] of Object.entries(cityMappings)) {
        if (queryLower.includes(searchTerm.toLowerCase())) {
            console.log('ğŸ™ï¸ Exact city match:', cityName, 'from:', searchTerm);
            return cityName;
        }
    }
    
    // ×©×œ×‘ 2: ×–×™×”×•×™ ×©×’×™××•×ª ×”×§×œ×“×”
    const words = queryLower.split(/\s+/);
    const mainCities = ['×ª×œ ××‘×™×‘', '×™×¨×•×©×œ×™×', '×—×™×¤×”', '×¨××ª ×’×Ÿ', '×¤×ª×— ×ª×§×•×•×”', '×”×¨×¦×œ×™×”', '× ×ª× ×™×”', '×¨××©×•×Ÿ ×œ×¦×™×•×Ÿ', '×‘××¨ ×©×‘×¢', '×›×¤×¨ ×¡×‘×'];
    
    for (const word of words) {
        if (word.length >= 3) {
            for (const city of mainCities) {
                const cityWords = city.split(' ');
                for (const cityWord of cityWords) {
                    const distance = levenshteinDistance(word, cityWord.toLowerCase());
                    if (distance <= 2 && word.length >= 4 && cityWord.length >= 4) {
                        console.log('ğŸ™ï¸ Fuzzy city match:', city, 'from:', word, 'â†’', cityWord, 'distance:', distance);
                        return city;
                    }
                }
            }
        }
    }
    
    return null;
}

// ×¤×•× ×§×¦×™×” ×œ×—×™×¤×•×© ×“×™×¨×•×ª ×‘-Supabase ×¢× ×¤×™×œ×˜×¨×™× ×—×›××™×
async function searchApartments(query) {
    try {
        console.log('ğŸ” Starting search with query:', query);
        
        // ×—×™×¤×•×© ×¢×™×¨
        const detectedCity = detectCity(query);
        
        // ×—×™×¤×•×© ××—×™×¨/×ª×§×¦×™×‘
        const priceMatch = query.match(/(\d+)\s*(××œ×£|×©×§×œ)/);
        const maxPrice = priceMatch ? parseInt(priceMatch[1]) * (priceMatch[2] === '××œ×£' ? 1000 : 1) : null;
        
        // ×—×™×¤×•×© ×—×“×¨×™×
        const roomsMatch = query.match(/(\d+)\s*×—×“×¨×™×?/);
        const rooms = roomsMatch ? parseInt(roomsMatch[1]) : null;
        
        // ×¡×•×’ ×¢×¡×§×”
        const isRental = query.includes('×”×©×›×¨×”') || query.includes('×œ×©×›×•×¨') || query.includes('×œ×”×©×›×™×¨');
        const isSale = query.includes('××›×™×¨×”') || query.includes('×œ×§× ×•×ª') || query.includes('×œ××›×™×¨×”');
        
        // ×‘× ×™×™×ª URL ×¢× ×¤×™×œ×˜×¨×™×
        let searchUrl = `${SUPABASE_URL}/rest/v1/apartments?select=*`;
        const params = [];
        
        if (detectedCity) {
            params.push(`city=eq.${encodeURIComponent(detectedCity)}`);
            console.log('ğŸ™ï¸ Filtering by city:', detectedCity);
        }
        
        if (rooms) {
            params.push(`rooms=eq.${rooms}`);
            console.log('ğŸ›ï¸ Filtering by rooms:', rooms);
        }
        
        if (isRental && !isSale) {
            params.push(`transaction_type=eq.×”×©×›×¨×”`);
            console.log('ğŸ  Filtering for rentals');
        } else if (isSale && !isRental) {
            params.push(`transaction_type=eq.××›×™×¨×”`);
            console.log('ğŸ’° Filtering for sales');
        }
        
        if (maxPrice) {
            params.push(`price=lte.${maxPrice}`);
            console.log('ğŸ’° Filtering by max price:', maxPrice);
        }
        
        // ××™×•×Ÿ ×œ×¤×™ ××—×™×¨ ×¢×•×œ×”
        params.push('order=price.asc');
        params.push('limit=8');
        
        if (params.length > 2) {
            searchUrl += '&' + params.join('&');
        } else {
            searchUrl += '&order=price.asc&limit=8';
        }
        
        console.log('ğŸ” Final search URL:', searchUrl);

        const response = await fetch(searchUrl, {
            headers: {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            console.log('ğŸ¯ Search results:', data.length, 'apartments found');
            if (data.length > 0) {
                console.log('ğŸ  Sample result:', data[0]);
                if (detectedCity) {
                    console.log('ğŸ™ï¸ City filter applied successfully for:', detectedCity);
                }
            }
            return data || [];
        } else {
            console.error('âŒ Search failed:', response.status, await response.text());
            return [];
        }
    } catch (e) {
        console.error('ğŸ’¥ Search error:', e);
        return [];
    }
}

// ×¤×•× ×§×¦×™×” ×œ× ×™×ª×•×— ××™×“×¢ ××”×©×™×—×”
function analyzeConversation(conversationText) {
    const text = conversationText.toLowerCase();
    
    const hasCity = detectCity(text) !== null;
    const hasBudget = /\d+\s*(×©×§×œ|××œ×£)/.test(text) || text.includes('×ª×§×¦×™×‘') || /\d+\s*â‚ª/.test(text);
    const hasFloor = text.includes('×§×•××”') || text.includes('×§×¨×§×¢') || text.includes('×’×‘×•×”') || /×§×•××”\s*\d+/.test(text);
    const hasTransactionType = text.includes('×”×©×›×¨×”') || text.includes('×§× ×™×™×”') || text.includes('××›×™×¨×”') || text.includes('×œ×©×›×•×¨') || text.includes('×œ×§× ×•×ª');
    const hasSize = text.includes('××˜×¨') || text.includes('×’×•×“×œ') || text.includes('×©×˜×—') || /\d+\s*×"×¨/.test(text);
    const hasRooms = /\d+\s*×—×“×¨×™×?/.test(text) || text.includes('×¡×˜×•×“×™×•') || text.includes('×—×“×¨');
    
    return { hasCity, hasBudget, hasFloor, hasTransactionType, hasSize, hasRooms };
}

// ×¤×•× ×§×¦×™×” ×œ×§×¨×™××” ×œ-AI
async function callAI(message, apartments) {
    try {
        console.log('ğŸ¤– AI called with apartments:', apartments.length);
        
        const apartmentData = apartments.length > 0 ? 
            `×“×™×¨×•×ª ×–××™× ×•×ª ×‘×××’×¨ (${apartments.length} ×“×™×¨×•×ª × ××¦××•):\n${apartments.map((apt, i) => 
                `×“×™×¨×” ${i+1}: ${apt.apartment_type || '×“×™×¨×”'} ${apt.rooms || '?'} ×—×“×¨×™× ×‘${apt.city || '×œ× ×™×“×•×¢'}, ${apt.street || '×¨×—×•×‘ ×œ× ×™×“×•×¢'} | ${apt.size_sqm}×"×¨ | ×§×•××” ${apt.floor || '×§×¨×§×¢'} | ${apt.furniture || '×œ×œ× ×¨×™×”×•×˜'} | ${apt.price?.toLocaleString()}â‚ª ×œ${apt.transaction_type}`
            ).join('\n')}` : 
            '×œ× × ××¦××• ×“×™×¨×•×ª ×‘×××’×¨ ×¢×“×™×™×Ÿ - ×”××©×š ×œ××¡×•×£ ××™×“×¢.';

        // ×©××™×¨×ª ×”×™×¡×˜×•×¨×™×™×ª ×”×©×™×—×”
        const conversationHistory = Array.from(messagesDiv.children)
            .filter(msg => msg.className === 'message')
            .slice(-10)
            .map(msg => {
                const isUser = msg.querySelector('.user-msg');
                const text = msg.querySelector(isUser ? '.user-msg' : '.bot-msg').textContent.replace(/\d{2}:\d{2}/, '').trim();
                return `${isUser ? '××©×ª××©' : '×™×•×¡×™'}: ${text}`;
            }).join('\n');

        // × ×™×ª×•×— ×”××™×“×¢ ×”×§×™×™×
        const analysis = analyzeConversation(conversationHistory);
        const detailsCount = Object.values(analysis).filter(Boolean).length;
        
        // ×‘×“×™×§×” ×× ×–×• ×”×”×•×“×¢×” ×”×¨××©×•× ×”
        const isFirstMessage = conversationHistory.trim() === '' || conversationHistory.includes('×”×™×™! ğŸ‘‹ ×× ×™ ×™×•×¡×™');
        
        console.log('ğŸ“Š Conversation analysis:', analysis, 'Details:', detailsCount, 'First message:', isFirstMessage);

        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: 'gpt-4o-mini',
                messages: [{
                    role: 'system',
                    content: `××ª×” ×™×•×¡×™, ×¡×•×›×Ÿ ×“×™×¨×•×ª ××§×¦×•×¢×™ ×•×¡×‘×œ× ×™! 

×”×™×¡×˜×•×¨×™×™×ª ×”×©×™×—×”:
${conversationHistory}

${apartmentData}

**×‘×“×•×§ ××™×œ×• ×¤×¨×˜×™× ×—×¡×¨×™× ××”×”×™×¡×˜×•×¨×™×”:**
- ×¢×™×¨: ${analysis.hasCity ? 'âœ…' : 'âŒ'}
- ×ª×§×¦×™×‘: ${analysis.hasBudget ? 'âœ…' : 'âŒ'}
- ×§×•××” ××•×¢×“×¤×ª: ${analysis.hasFloor ? 'âœ…' : 'âŒ'}  
- ×¡×•×’ ×¢×¡×§×” (×”×©×›×¨×”/×§× ×™×™×”): ${analysis.hasTransactionType ? 'âœ…' : 'âŒ'}
- ×’×•×“×œ ×“×™×¨×”/×©×˜×—: ${analysis.hasSize ? 'âœ…' : 'âŒ'}
- ××¡×¤×¨ ×—×“×¨×™×: ${analysis.hasRooms ? 'âœ…' : 'âŒ'}
×¤×¨×˜×™× ×§×™×™××™×: ${detailsCount}/6

**×”×•×¨××•×ª ××—×™×™×‘×•×ª:**

${detailsCount === 6 ? `
ğŸ¯ ×™×© ××ª ×›×œ 6 ×”×¤×¨×˜×™×! ×¢×›×©×™×• ×‘×“×•×§ ×‘×××’×¨:

${apartments.length > 0 ? `
×™×© ${apartments.length} ×“×™×¨×•×ª ×‘×××’×¨! ×”×¦×’ ××ª ×”×“×™×¨×•×ª ×”×××™×ª×™×•×ª ××”×××’×¨:
- **×—×•×‘×”: ×”×©×ª××© ×¨×§ ×‘× ×ª×•× ×™× ×”××“×•×™×§×™× ××”×××’×¨ ×©×§×™×‘×œ×ª!**
- **××œ ×ª××¦×™× ×›×ª×•×‘×•×ª, ×¨×—×•×‘×•×ª, ××• ×¤×¨×˜×™× ×©×œ× ××•×¤×™×¢×™× ×‘×××’×¨!**
- ×”×¦×’ ×›×œ ×“×™×¨×” ×¢× ×”×¤×¨×˜×™× ×”××“×•×™×§×™×: ××—×™×¨, ×¢×™×¨, ×¨×—×•×‘, ×—×“×¨×™×, ×’×•×“×œ, ×§×•××”, ×¨×™×”×•×˜
- ×”×¡×‘×¨ ×œ××” ×›×œ ×“×™×¨×” ××ª××™××”
- ×ª×Ÿ ×”××œ×¦×” ×¢×œ ×”×“×™×¨×” ×”×˜×•×‘×” ×‘×™×•×ª×¨
` : `
ğŸ˜ ×œ× ××¦××ª×™ ×“×™×¨×•×ª ×‘×××’×¨ ×©××ª××™××•×ª ×œ×›×œ ×”×§×¨×™×˜×¨×™×•× ×™× ×©×œ×š:
- ×¢×™×¨: ${detectedCity || '×œ× ×¦×•×™×Ÿ'}
- ×ª×§×¦×™×‘: ${maxPrice ? maxPrice.toLocaleString() + 'â‚ª' : '×œ× ×¦×•×™×Ÿ'}
- ×—×“×¨×™×: ${rooms || '×œ× ×¦×•×™×Ÿ'}
- ×¡×•×’ ×¢×¡×§×”: ${isRental ? '×”×©×›×¨×”' : isSale ? '××›×™×¨×”' : '×œ× ×¦×•×™×Ÿ'}

××•×œ×™ ×ª×¨×¦×” ×œ×©× ×•×ª ×§×¨×™×˜×¨×™×•×Ÿ ××—×“? ×œ××©×œ:
ğŸ™ï¸ ×¢×™×¨ ××—×¨×ª?
ğŸ’° ×ª×§×¦×™×‘ ×’×‘×•×” ×™×•×ª×¨?
ğŸ›ï¸ ××¡×¤×¨ ×—×“×¨×™× ×©×•× ×”?

**×œ× ×™××¦×™× ×“×™×¨×•×ª ×©×œ× ×§×™×™××•×ª ×‘×××’×¨!**
`}
` : isFirstMessage || detailsCount === 0 ? `
ğŸ‘‹ ×–×•×”×™ ×”×”×•×“×¢×” ×”×¨××©×•× ×”! ×”×ª×—×œ ×¢×: "×‘××™×–×” ×¢×™×¨ ××ª×” ××—×¤×© ×“×™×¨×”?"
` : `
ğŸ“ ×—×¡×¨×™× ×¢×•×“ ${6-detailsCount} ×¤×¨×˜×™×! ×©××œ ×‘×“×™×•×§ ××ª ×”×©××œ×” ×”×‘××” ×‘×¡×“×¨:

1. ${!analysis.hasCity ? 'ğŸ™ï¸ "×‘××™×–×” ×¢×™×¨ ××ª×” ××—×¤×© ×“×™×¨×”?"' : 'âœ… ×¢×™×¨'}
2. ${!analysis.hasBudget ? 'ğŸ’° "××” ×”×ª×§×¦×™×‘ ×©×œ×š? (×œ×—×•×“×© ×× ×”×©×›×¨×”, ×¡×”"×› ×× ×§× ×™×™×”)"' : 'âœ… ×ª×§×¦×™×‘'}
3. ${!analysis.hasFloor ? 'ğŸ¢ "××™×–×” ×§×•××” ××ª×” ××¢×“×™×£? (×§×¨×§×¢, ×’×‘×•×”, ×œ×œ× ×”×¢×“×¤×”)"' : 'âœ… ×§×•××”'}
4. ${!analysis.hasTransactionType ? 'ğŸ  "×–×” ×œ×§× ×™×™×” ××• ×œ×”×©×›×¨×”?"' : 'âœ… ×¡×•×’ ×¢×¡×§×”'}
5. ${!analysis.hasSize ? 'ğŸ“ "××™×–×” ×’×•×“×œ ×“×™×¨×” ××ª×” ××—×¤×©? (×§×˜× ×”/×‘×™× ×•× ×™×ª/×’×“×•×œ×”)"' : 'âœ… ×’×•×“×œ'}
6. ${!analysis.hasRooms ? 'ğŸ›ï¸ "×›××” ×—×“×¨×™× ××ª×” ×¦×¨×™×š?"' : 'âœ… ×—×“×¨×™×'}

×©××œ ×¨×§ ××ª ×”×©××œ×” ×”×¨××©×•× ×” ×©×—×¡×¨×”! ××œ ×ª×–×¨×•×§ ×“×™×¨×•×ª ×¢×“ ×©×™×© ×”×›×œ!
`}

×ª××™×“ ×©××œ ×©××œ×” ××—×ª ×‘×œ×‘×“ ×•×‘×¡×“×¨ ×”× ×›×•×Ÿ!`
                }, {
                    role: 'user',
                    content: message
                }],
                max_tokens: 600,
                temperature: 0.3
            })
        });

        if (response.ok) {
            const data = await response.json();
            chatCount++;
            totalCost += 0.003;
            updateUsage();
            return data.choices[0].message.content;
        } else {
            const errorText = await response.text();
            console.error('OpenAI error:', response.status, errorText);
            return 'âŒ ×©×’×™××” ×–×× ×™×ª. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢.';
        }
    } catch (e) {
        console.error('AI call error:', e);
        return 'ğŸŒ ×‘×¢×™×” ×‘×—×™×‘×•×¨. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.';
    }
}

// ×¤×•× ×§×¦×™×” ×¨××©×™×ª ×œ×©×œ×™×—×ª ×”×•×“×¢×”
async function send() {
    const message = inputEl.value.trim();
    if (!message) return;

    addMessage('user', message);
    inputEl.value = '';
    showTyping();

    try {
        // ×—×™×¤×•×© ×“×™×¨×•×ª ×¢×œ ×‘×¡×™×¡ ×›×œ ×”×”×™×¡×˜×•×¨×™×” + ×”×•×“×¢×” × ×•×›×—×™×ª
        const allMessages = Array.from(messagesDiv.children)
            .filter(msg => msg.className === 'message')
            .map(msg => {
                const isUser = msg.querySelector('.user-msg');
                return msg.querySelector(isUser ? '.user-msg' : '.bot-msg').textContent.replace(/\d{2}:\d{2}/, '').trim();
            }).join(' ');

        const fullContext = allMessages + ' ' + message;
        console.log('ğŸ” Searching with full context:', fullContext);
        
        const apartments = await searchApartments(fullContext);
        const response = await callAI(message, apartments);
        
        hideTyping();
        addMessage('bot', response);
    } catch (e) {
        hideTyping();
        console.error('Send error:', e);
        addMessage('bot', '××¦×˜×¢×¨, ×™×© ×‘×¢×™×” ×˜×›× ×™×ª. × ×¡×” ×©×•×‘.');
    }
}

// ×¤×•× ×§×¦×™×” ×œ×”×’×“×¨×ª ×˜×§×¡×˜ ×‘×©×“×” ×”×§×œ×˜
function setInput(text) {
    inputEl.value = text;
}

// ×¤×•× ×§×¦×™×” ×œ×¢×“×›×•×Ÿ × ×ª×•× ×™ ×©×™××•×©
function updateUsage() {
    usageEl.textContent = `×©×™×—×•×ª: ${chatCount} | ×¢×œ×•×ª: $${totalCost.toFixed(3)}`;
}

// ×××–×™× ×™ ××™×¨×•×¢×™×
inputEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
    }
});

// ×”×ª×—×œ×”
window.addEventListener('load', () => {
    addMessage('bot', '×”×™×™! ğŸ‘‹ ×× ×™ ×™×•×¡×™, ×”×¡×•×›×Ÿ ×©×œ×š ×œ×—×™×¤×•×© ×“×™×¨×•×ª.\n\n×‘××™×–×” ×¢×™×¨ ××ª×” ××—×¤×© ×“×™×¨×”? ğŸ ');
});